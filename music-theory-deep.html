<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Mathematics of Sound â€” A Unified Theory</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap');

  :root {
    --ink: #0e0e10;
    --paper: #f5f0e8;
    --gold: #b8860b;
    --gold-light: #e8c860;
    --rust: #8b2500;
    --slate: #2a3240;
    --muted: #7a7060;
    --accent: #1a4a6b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 18px;
    line-height: 1.75;
    overflow-x: hidden;
  }

  /* â”€â”€ HERO â”€â”€ */
  .hero {
    min-height: 100vh;
    display: grid;
    place-items: center;
    background: var(--slate);
    position: relative;
    overflow: hidden;
    padding: 4rem 2rem;
  }

  .hero-bg {
    position: absolute; inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 20% 80%, rgba(184,134,11,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 80% at 80% 20%, rgba(26,74,107,0.2) 0%, transparent 60%);
  }

  /* Tone-circle SVG background */
  .tone-ring {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    opacity: 0.08;
    animation: slow-spin 120s linear infinite;
  }
  @keyframes slow-spin { to { transform: rotate(360deg); } }

  .hero-content {
    position: relative; z-index: 2; text-align: center; max-width: 860px;
  }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem; letter-spacing: 0.25em;
    color: var(--gold-light); text-transform: uppercase;
    margin-bottom: 2rem;
    opacity: 0; animation: fade-up 1s 0.3s forwards;
  }

  .hero h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.5rem, 7vw, 5.5rem);
    font-weight: 900; color: var(--paper);
    line-height: 1.05;
    opacity: 0; animation: fade-up 1s 0.5s forwards;
  }

  .hero h1 em {
    font-style: italic; color: var(--gold-light);
  }

  .hero-sub {
    margin-top: 2rem;
    font-size: 1.1rem; color: rgba(245,240,232,0.65);
    max-width: 600px; margin-left: auto; margin-right: auto;
    opacity: 0; animation: fade-up 1s 0.8s forwards;
  }

  .hero-pills {
    margin-top: 3rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;
    opacity: 0; animation: fade-up 1s 1.1s forwards;
  }
  .pill {
    font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.15em;
    text-transform: uppercase; padding: 0.5rem 1.2rem;
    border: 1px solid rgba(184,134,11,0.5); color: var(--gold-light);
    border-radius: 999px;
  }

  @keyframes fade-up {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  .page { max-width: 820px; margin: 0 auto; padding: 5rem 2rem; }

  /* â”€â”€ CHAPTER HEADERS â”€â”€ */
  .chapter {
    margin-top: 7rem;
    border-top: 1px solid var(--gold);
    padding-top: 2.5rem;
  }

  .chapter-num {
    font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.2em;
    text-transform: uppercase; color: var(--gold);
    margin-bottom: 0.75rem;
  }

  .chapter h2 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    font-weight: 700; line-height: 1.15;
    color: var(--slate);
  }

  .chapter h2 em { font-style: italic; color: var(--rust); }

  /* â”€â”€ SECTION HEADERS â”€â”€ */
  h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem; font-weight: 600;
    color: var(--slate);
    margin: 3rem 0 1rem;
  }

  h4 {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin: 2rem 0 0.5rem;
  }

  p { margin-bottom: 1.2rem; }

  /* â”€â”€ MATH BLOCKS â”€â”€ */
  .math-block {
    background: var(--slate);
    color: var(--paper);
    border-left: 3px solid var(--gold);
    padding: 1.5rem 2rem;
    margin: 2rem 0;
    border-radius: 0 4px 4px 0;
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.8;
    overflow-x: auto;
  }
  .math-block .comment { color: var(--gold-light); font-style: italic; }
  .math-block .highlight { color: #f0c060; font-weight: 500; }
  .math-block .dim { color: rgba(245,240,232,0.45); }

  /* â”€â”€ CALLOUT â”€â”€ */
  .callout {
    border: 1px solid var(--gold);
    background: rgba(184,134,11,0.06);
    padding: 1.5rem 2rem;
    margin: 2.5rem 0;
    position: relative;
  }
  .callout::before {
    content: attr(data-label);
    position: absolute; top: -0.6rem; left: 1.5rem;
    background: var(--paper); padding: 0 0.5rem;
    font-family: 'DM Mono', monospace; font-size: 0.65rem;
    letter-spacing: 0.2em; text-transform: uppercase; color: var(--gold);
  }

  /* â”€â”€ RATIO TABLE â”€â”€ */
  .ratio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 1px; background: rgba(0,0,0,0.12);
    border: 1px solid rgba(0,0,0,0.12);
    margin: 2rem 0; font-family: 'DM Mono', monospace; font-size: 0.8rem;
  }
  .ratio-cell {
    background: var(--paper); padding: 0.8rem 1rem;
  }
  .ratio-cell .label { color: var(--muted); font-size: 0.7rem; }
  .ratio-cell .val { font-size: 1rem; color: var(--slate); font-weight: 500; }
  .ratio-cell .cents { color: var(--rust); font-size: 0.75rem; }

  /* â”€â”€ TONNETZ SVG â”€â”€ */
  .fig-wrap {
    margin: 3rem 0; text-align: center;
  }
  .fig-caption {
    font-size: 0.85rem; color: var(--muted); font-style: italic;
    margin-top: 1rem;
    font-family: 'EB Garamond', serif;
  }

  /* â”€â”€ INLINE CODE â”€â”€ */
  code {
    font-family: 'DM Mono', monospace; font-size: 0.85em;
    background: rgba(42,50,64,0.1); padding: 0.15em 0.4em;
    border-radius: 3px; color: var(--rust);
  }

  /* â”€â”€ NETWORK DIAGRAM â”€â”€ */
  .net-diagram {
    background: var(--slate);
    padding: 2rem;
    margin: 2rem 0;
    border-radius: 4px;
    display: flex; justify-content: center;
  }

  /* â”€â”€ SEPARATOR â”€â”€ */
  .sep {
    text-align: center; color: var(--gold); font-size: 1.2rem;
    letter-spacing: 0.8em; margin: 4rem 0;
  }

  /* â”€â”€ PULL QUOTE â”€â”€ */
  .pullquote {
    border-left: 4px solid var(--rust);
    padding: 1rem 2rem; margin: 2.5rem 0;
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem; font-style: italic; color: var(--slate);
  }

  /* â”€â”€ HARMONIC SERIES VIZ â”€â”€ */
  canvas#harmonic { width: 100%; height: 140px; }

  /* â”€â”€ SCALE LATTICE â”€â”€ */
  svg text { font-family: 'DM Mono', monospace; }

  /* â”€â”€ FOOTER â”€â”€ */
  footer {
    background: var(--slate); color: rgba(245,240,232,0.5);
    text-align: center; padding: 3rem;
    font-family: 'DM Mono', monospace; font-size: 0.75rem;
    letter-spacing: 0.1em;
    margin-top: 8rem;
  }

  /* â”€â”€ PROGRESS BAR â”€â”€ */
  .read-progress {
    position: fixed; top: 0; left: 0; height: 2px;
    background: var(--gold); z-index: 999;
    width: 0%; transition: width 0.1s linear;
  }

  /* â”€â”€ TONE CIRCLE â”€â”€ */
  #tone-canvas { display: block; margin: 0 auto; max-width: 420px; width: 100%; }

  /* â”€â”€ INTERACTIVE â”€â”€ */
  .chord-btn {
    font-family: 'DM Mono', monospace; font-size: 0.75rem;
    padding: 0.5rem 1rem; margin: 0.25rem;
    border: 1px solid var(--slate); background: var(--paper); cursor: pointer;
    transition: all 0.2s; letter-spacing: 0.08em;
  }
  .chord-btn:hover { background: var(--slate); color: var(--paper); }
  .chord-btn.active { background: var(--rust); color: var(--paper); border-color: var(--rust); }

  #chord-canvas { display: block; margin: 1rem auto; max-width: 460px; width: 100%; }

  .tag-line {
    font-family: 'DM Mono', monospace; font-size: 0.7rem;
    color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase;
    margin-bottom: 0.3rem;
  }

  strong { color: var(--slate); }

  /* Lattice scroll hint */
  .scroll-hint {
    font-family: 'DM Mono', monospace; font-size: 0.7rem;
    color: var(--muted); text-align: center; margin-top: -1rem; margin-bottom: 2rem;
  }
</style>
</head>
<body>

<div class="read-progress" id="rp"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HERO -->
<section class="hero">
  <div class="hero-bg"></div>

  <!-- rotating tone circle -->
  <div class="tone-ring">
    <svg width="700" height="700" viewBox="-350 -350 700 700">
      <circle r="300" fill="none" stroke="#e8c860" stroke-width="0.5"/>
      <circle r="220" fill="none" stroke="#e8c860" stroke-width="0.5"/>
      <circle r="140" fill="none" stroke="#e8c860" stroke-width="0.5"/>
      <script>
      </script>
      <!-- 12 radial lines -->
      <g id="radials" stroke="#e8c860" stroke-width="0.4">
        <line x1="0" y1="-140" x2="0" y2="-300"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(30)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(60)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(90)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(120)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(150)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(180)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(210)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(240)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(270)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(300)"/>
        <line x1="0" y1="-140" x2="0" y2="-300" transform="rotate(330)"/>
      </g>
    </svg>
  </div>

  <div class="hero-content">
    <p class="hero-eyebrow">Algebraic Geometry Â· Psychoacoustics Â· Neural Networks</p>
    <h1>The <em>Hidden Mathematics</em> of Sound</h1>
    <p class="hero-sub">A unified demystification of tuning scales, chords, and progressions â€” from chromatic to microtonal â€” through the lens of modern mathematics and cognitive science.</p>
    <div class="hero-pills">
      <span class="pill">Tonnetz Topology</span>
      <span class="pill">Harmonic Ratios</span>
      <span class="pill">Roughness Models</span>
      <span class="pill">Orbifolds</span>
      <span class="pill">Microtonal Lattices</span>
      <span class="pill">Combinatorics</span>
    </div>
  </div>
</section>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE -->
<main class="page">

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INTRODUCTION -->
<section class="chapter">
  <p class="chapter-num">Prelude</p>
  <h2>Why Music is <em>Geometry</em></h2>
  <p>Every pitch is a frequency â€” a number. Every interval is a <em>ratio</em> between two numbers. And every musical system â€” Western, Indian, Arabic, gamelan â€” is an attempt to tile the infinite real line of frequencies into a finite, navigable structure that the human brain can <strong>remember, anticipate, and resolve</strong>.</p>
  <p>This is not metaphor. The relationships between notes form algebraic groups. Chord progressions trace paths on topological spaces. Consonance and dissonance are outputs of a neuroacoustic computation implemented in the basilar membrane and auditory cortex. And the combinatorial explosion of possible chords and scales in microtonal systems can be tamed by the same lattice theory used in crystallography and coding theory.</p>
  <div class="pullquote">"Music is the arithmetic of sounds as optics is the geometry of light." â€” Claude Debussy</div>
  <p>We will move through three interlocking frameworks: <strong>algebraic geometry</strong> (structure of pitch space), <strong>psychoacoustics</strong> (how the brain scores consonance), and <strong>combinatorics / neural networks</strong> (how progressions are generated and learned).</p>
</section>


<!-- â•â•â•â•â•â•â•â•â•â•â• CHAPTER 1 -->
<section class="chapter">
  <p class="chapter-num">Chapter I â€” Algebraic Geometry</p>
  <h2>Pitch Space as a <em>Geometric Object</em></h2>

  <h3>1.1 The Fundamental Group of Pitch</h3>
  <p>Start with a single physical truth: doubling a frequency raises pitch by exactly one <strong>octave</strong>. This gives us a logarithmic equivalence relation: two frequencies <em>f</em> and <em>f'</em> are <em>octave-equivalent</em> if <code>f' = 2â¿Â·f</code> for some integer <em>n</em>. Quotienting the positive reals â„âº by this relation yields the circle ğ•ŠÂ¹ â€” the <strong>pitch class space</strong>.</p>

  <div class="math-block">
<span class="comment">-- Pitch class space as a quotient group --</span>

<span class="highlight">PC</span> = â„âº / (f ~ 2f)   â‰…   â„ / â„¤   â‰…   ğ•ŠÂ¹

<span class="dim">Each point on the circle is a pitch class, independent of octave.
A "C" at 261 Hz and a "C" at 523 Hz are the same point.</span>

<span class="highlight">12-TET</span>: partition ğ•ŠÂ¹ into 12 equal parts
â†’ cyclic group  â„¤â‚â‚‚ = ğ•ŠÂ¹ / (x ~ x + 1/12)

<span class="highlight">n-TET</span>: equal temperament with n divisions
â†’ cyclic group  â„¤â‚™,   n âˆˆ {5, 7, 17, 19, 24, 31, 41, 53 ...}

<span class="highlight">Just Intonation (JI)</span>: dense subgroup of ğ•ŠÂ¹
â†’ generated by prime ratios {2, 3, 5, 7, 11, 13 ...}
  </div>

  <p>12-TET is a discrete approximation of the circle â€” a <strong>lattice in ğ•ŠÂ¹</strong>. Microtonal systems simply choose finer lattices, recovering more of the continuous pitch space.</p>

  <h3>1.2 Multi-Dimensional Pitch Lattices (Just Intonation)</h3>
  <p>In pure just intonation, every interval is a rational number <em>p/q</em> built from prime factors. If we restrict to the 5-limit (primes 2, 3, 5), every pitch ratio is of the form <code>2áµƒ Â· 3áµ‡ Â· 5á¶œ</code>. Modding out octaves (powers of 2), pitch-class space becomes a <strong>2D lattice</strong> â€” the Tonnetz.</p>

  <div class="math-block">
<span class="comment">-- 5-Limit Lattice (Euler's Tonnetz) --</span>

Generators (mod octave):
  <span class="highlight">Perfect Fifth</span>:  3/2   â†’  702Â¢  (x-axis)
  <span class="highlight">Major Third</span>:   5/4   â†’  386Â¢  (y-axis)

Lattice point (a, b) represents pitch class:
  <span class="highlight">P(a,b)</span> = 3áµƒ Â· 5áµ‡  (mod 2, normalized to [1,2))

Cents value:
  <span class="highlight">Â¢(a,b)</span> = (aÂ·logâ‚‚3 + bÂ·logâ‚‚5) Â· 1200  (mod 1200)

<span class="dim">-- 7-limit adds a z-axis: generator 7/4 = 969Â¢ --
-- 11-limit adds a 4th dimension              --
-- Higher limits: hyperlattices in â„â¿         --</span>
  </div>

  <!-- TONNETZ SVG -->
  <div class="fig-wrap">
    <svg id="tonnetz" viewBox="-20 -20 520 360" width="100%" style="max-width:520px; background: var(--slate); border-radius:4px;">
      <!-- Will be populated by JS -->
    </svg>
    <p class="fig-caption">Fig. 1 â€” The Tonnetz: a 2D lattice of pitch classes under 5-limit just intonation. Horizontal = perfect fifths (Ã—3/2), diagonal = major thirds (Ã—5/4). Each triangle is a triad.</p>
  </div>

  <h3>1.3 Chord Spaces as Orbifolds</h3>
  <p>The music theorist Dmitri Tymoczko showed that the space of all <em>n</em>-note chords (unordered pitch-class multisets) forms a mathematical object called an <strong>orbifold</strong> â€” a quotient of a torus by a finite group action.</p>

  <div class="math-block">
<span class="comment">-- Chord space for n voices (Tymoczko 2006) --</span>

Voice-leading space  <span class="highlight">Tâ¿/Sâ‚™</span>
  where  Tâ¿ = (â„/12â„¤)â¿   is the n-torus of n-voice chords
         Sâ‚™ = symmetric group  (reordering voices)

n=2 (dyads):  TÂ²/Sâ‚‚  is a MÃ¶bius strip
n=3 (triads): TÂ³/Sâ‚ƒ  is a 3-orbifold  (twisted prism)
n=4 (tetrads):Tâ´/Sâ‚„  is a 4-orbifold

<span class="highlight">Key insight</span>: efficient voice leading = SHORT PATHS in this orbifold.
A Cmaj â†’ Amin motion (C-E-G â†’ C-E-A) moves only one voice by 1 semitone.
It is geometrically NEARBY â€” a tiny step in TÂ³/Sâ‚ƒ.

<span class="dim">Singular points of the orbifold = maximally even chords
(diminished 7th, augmented triad, whole-tone scale)
These are the "symmetric" chords at the orbifold's corners.</span>
  </div>

  <div class="callout" data-label="Geometric Insight">
    <p>The reason Bach's voice-leading feels "smooth" is literally geometric: his progressions trace short paths through chord-space orbifolds. Rock music with parallel motion, by contrast, takes long straight paths along the orbifold's axes.</p>
  </div>

  <h3>1.4 The Circle of Fifths as a â„¤â‚â‚‚ Quotient</h3>
  <p>The cycle of fifths â€” C G D A E B Fâ™¯ Câ™¯ Gâ™¯ Eâ™­ Bâ™­ F C â€” is the orbit of C under repeated multiplication by 3/2 (mod 2), i.e., the generator of â„¤â‚â‚‚ of order 12. This is why 12-TET "closes" the spiral â€” the comma that doesn't resolve in just tuning.</p>

  <div class="math-block">
<span class="comment">-- Pythagorean comma: why 12 fifths â‰  7 octaves --</span>

12 perfect fifths in JI: (3/2)Â¹Â²   = 531441/4096  â‰ˆ  129.746
7 octaves:               2â·         = 128

<span class="highlight">Pythagorean comma</span>: 531441/524288  â‰ˆ  1.01364  â‰ˆ  23.46Â¢

In 12-TET, each fifth is compressed to:
  <span class="highlight">2^(7/12)</span> = 1.49831...  (vs JI 1.50000)
  error = âˆ’1.955Â¢ per fifth  Ã—12 = âˆ’23.46Â¢  âœ“  closes perfectly

<span class="dim">19-TET: fifths are +6.9Â¢ sharp (tolerable, better thirds)
31-TET: fifths are âˆ’5.2Â¢ flat (close to meantone)
53-TET: fifths are âˆ’0.07Â¢ flat (nearly perfect JI)</span>
  </div>

  <h3>1.5 Scales as Maximally Even Sets</h3>
  <p>Why does the diatonic scale (WWHWWWH) feel "right"? Because it is the <strong>maximally even</strong> 7-note subset of â„¤â‚â‚‚ â€” the set whose elements are distributed as evenly as possible around the circle. This is a combinatorial optimality condition with a precise algebraic definition.</p>

  <div class="math-block">
<span class="comment">-- Maximally Even Sets (Clough & Douthett 1991) --</span>

Given: n pitches in a c-chromatic universe (n=7, c=12 for diatonic)

ME set: { âŒŠ(cÂ·k + m)/nâŒ‹  :  k = 0,1,...,n-1 }
  for some offset m.

Diatonic (m=0):  { 0, 2, 4, 5, 7, 9, 11 }  = C major

<span class="highlight">Proof of uniqueness</span>: Any other 7-subset of â„¤â‚â‚‚ has
a less uniform distribution â€” verified by measuring
the "evenness" functional:  E(S) = Î£áµ¢â±¼ |sáµ¢âˆ’sâ±¼ âˆ’ cÂ·(iâˆ’j)/n|

Diatonic scale <span class="highlight">minimizes</span> E(S) over all 7-subsets of â„¤â‚â‚‚.

<span class="dim">Pentatonic (n=5, c=12): { 0,2,4,7,9 }  also maximally even
Chromatic (n=12,c=12): trivially even = â„¤â‚â‚‚ itself</span>
  </div>

</section>


<!-- â•â•â•â•â•â•â•â•â•â•â• CHAPTER 2 -->
<section class="chapter">
  <p class="chapter-num">Chapter II â€” Psychoacoustics</p>
  <h2>How the Brain <em>Scores</em> Consonance</h2>

  <h3>2.1 The Harmonic Series as the Universal Template</h3>
  <p>Every acoustic instrument produces a tone that is <em>not</em> a single frequency but a <strong>harmonic series</strong>: the fundamental fâ‚€ plus overtones at 2fâ‚€, 3fâ‚€, 4fâ‚€, 5fâ‚€... The auditory cortex is tuned to detect this pattern as a coherent "object." Consonance emerges when two notes share many overtones.</p>

  <div class="fig-wrap">
    <canvas id="harmonic" width="800" height="140"></canvas>
    <p class="fig-caption">Fig. 2 â€” Harmonic series of a 220 Hz tone. Each bar is a partial. The dashed lines mark where partials of a perfect fifth (330 Hz) overlap â€” shared overtones at 660, 1320, 1980 Hz...</p>
  </div>

  <h3>2.2 Helmholtz Roughness and Plompâ€“Levelt Curves</h3>
  <p>Consonance is not merely "pleasantness" â€” it is a measurable quantity. When two pure sinusoids are close in frequency, their interference creates <strong>beating</strong> at rate |fâ‚âˆ’fâ‚‚|. The cochlea processes sound via a tonotopic map along the basilar membrane; two tones within one <strong>critical bandwidth</strong> (~1.5â€“2 semitones at most frequencies) excite overlapping hair cells, causing neural roughness.</p>

  <div class="math-block">
<span class="comment">-- Plompâ€“Levelt (1965) roughness model --</span>

For two pure tones fâ‚ < fâ‚‚:
  Î”f = fâ‚‚ âˆ’ fâ‚                     (frequency difference)
  CBW(fâ‚) â‰ˆ 1.72 Â· fâ‚^0.65         (critical bandwidth, Hz)

<span class="highlight">Roughness</span> R(Î”f) â‰ˆ Î”f/CBW Â· exp(1 âˆ’ Î”f/CBW)   for Î”f â‰¤ CBW
                  â‰ˆ 0                               for Î”f > CBW

This is 0 at Î”f=0 (unison), peaks at Î”f â‰ˆ 0.25Â·CBW (~1 semitone),
returns to 0 at Î”f > CBW.

<span class="comment">-- Full chord roughness (Sethares 1993) --</span>

For chord with partials {(fáµ¢, aáµ¢)}:
  <span class="highlight">R_total</span> = Î£áµ¢ Î£â±¼>áµ¢  aáµ¢Â·aâ±¼ Â· roughness(fáµ¢, fâ±¼)

Major triad C-E-G: R â‰ˆ 0.31  (low)
Minor 2nd C-Câ™¯:   R â‰ˆ 0.89  (high)
  </div>

  <div class="ratio-grid">
    <div class="ratio-cell">
      <div class="label">Unison</div>
      <div class="val">1:1</div>
      <div class="cents">0Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Octave</div>
      <div class="val">2:1</div>
      <div class="cents">1200Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Perfect 5th</div>
      <div class="val">3:2</div>
      <div class="cents">702Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Perfect 4th</div>
      <div class="val">4:3</div>
      <div class="cents">498Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Major 3rd</div>
      <div class="val">5:4</div>
      <div class="cents">386Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Minor 3rd</div>
      <div class="val">6:5</div>
      <div class="cents">316Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Harmonic 7th</div>
      <div class="val">7:4</div>
      <div class="cents">969Â¢</div>
    </div>
    <div class="ratio-cell">
      <div class="label">Tritone (JI)</div>
      <div class="val">45:32</div>
      <div class="cents">590Â¢</div>
    </div>
  </div>

  <p>The integer complexity of a ratio directly predicts roughness: <strong>simpler ratios (small integers) = more coincident harmonics = less roughness = perceived consonance</strong>. This is why 3:2 (perfect fifth) is universally consonant and 45:32 (tritone) is the canonical dissonance.</p>

  <h3>2.3 Virtual Pitch and the Brain's Harmonic Template</h3>
  <p>The auditory brainstem performs a remarkable computation: it infers a <em>missing fundamental</em> from harmonic patterns. Present partials 200, 300, 400, 500 Hz â€” the brain hears 100 Hz even though no 100 Hz energy exists. This is <strong>virtual pitch</strong>, implemented via autocorrelation of neural firing patterns in the cochlear nucleus.</p>

  <div class="math-block">
<span class="comment">-- Meddis & O'Mard (1997) autocorrelation model --</span>

Neural firing rate r(t) follows hair-cell transduction.

<span class="highlight">Summary autocorrelation</span>:
  A(Ï„) = Î£_channels  âˆ« r_c(t) Â· r_c(t+Ï„) dt

Peak at Ï„ = 1/fâ‚€  â†’  perceived pitch = fâ‚€

<span class="comment">-- Why chords have "roots" --</span>
C major (Câ‚„ Eâ‚„ Gâ‚„): partials include 261, 330, 392, 523, 660...
A(Ï„) has peak at Ï„ = 1/130.8 Hz  â†’  virtual pitch = Câ‚ƒ (root!)

<span class="highlight">Chord root</span> = virtual pitch of the full harmonic series.
This is why root-position chords sound "grounded":
their virtual pitch matches their bass note.
  </div>

  <h3>2.4 Sensory vs. Cognitive Consonance</h3>
  <p>Roughness explains <em>sensory</em> consonance (acoustic physics), but <strong>cognitive</strong> consonance is context-dependent. The tritone resolves to a fifth in tonal music; in blues it is stable. This is learned expectation â€” a Bayesian prior built from exposure. The brain continuously predicts the next chord, and consonance is partly <em>how surprising the prediction error is</em>.</p>

  <div class="callout" data-label="Cross-Cultural Note">
    <p>In maqam music (Arabic/Turkish), the neutral third (~350Â¢, between minor and major) is highly consonant â€” neither rougher nor simpler than the Western major third. Consonance norms are partly cultural, partly acoustic. The brain's template is flexible.</p>
  </div>

  <h3>2.5 Microtonal Consonance: Beyond 12-TET</h3>
  <p>In 31-TET, the major third is 387Â¢ (vs JI's 386Â¢) â€” essentially just. Its roughness is dramatically lower than 12-TET's 400Â¢ major third. The 7-limit harmonic 7th (7:4 = 969Â¢) is accessible in 31-TET as the step near 968Â¢. Gamelan pÃ©log and slÃ©ndro scales exploit inharmonic spectra from metallic bars â€” their consonance curves are entirely different from those of string instruments, proving that <strong>consonance is relative to timbre's harmonic series</strong>.</p>

  <div class="math-block">
<span class="comment">-- Sethares timbre-tuning principle --</span>

Optimal tuning for an instrument:
  Minimize R_total(chord) given <span class="highlight">the instrument's actual partial series</span>

String/voice (harmonic partials f, 2f, 3f, ...):
  â†’ optimal consonances at ratios 2:1, 3:2, 4:3, 5:4  (JI intervals)
  â†’ 12-TET approximates these well

Metallic bar (inharmonic partials f, 2.76f, 5.41f, ...):
  â†’ optimal consonances at <span class="highlight">different</span> irrational ratios
  â†’ gamelan scales (~5 or 7 notes, non-equal spacing) minimize roughness

<span class="dim">Conclusion: scale = optimal roughness minimizer for timbre.
Each culture's instruments shaped their tuning systems.</span>
  </div>

</section>


<!-- â•â•â•â•â•â•â•â•â•â•â• CHAPTER 3 -->
<section class="chapter">
  <p class="chapter-num">Chapter III â€” Combinatorics & Neural Networks</p>
  <h2>Progressions as <em>Paths</em> in a Learned Space</h2>

  <h3>3.1 Counting Scales and Chords: The Combinatorial Explosion</h3>
  <p>How many distinct scales exist? In 12-TET, a scale is a subset of â„¤â‚â‚‚ containing the root. There are 2Â¹Â¹ = 2048 such subsets, but modding out rotational equivalence and reflection gives 352 distinct scale types (Sloane A000031). In 31-TET, the number explodes to millions.</p>

  <div class="math-block">
<span class="comment">-- Burnside's lemma: counting distinct scales --</span>

G = dihedral group D_n acting on n-element pitch circle.
|G| = 2n  (n rotations + n reflections)

<span class="highlight">|Distinct scales of size k|</span> = (1/|G|) Î£_{gâˆˆG} |Fix(g)|

For 12-TET, 7-note scales:
  Rotational equivalents only: C(12,7)/12 = 66
  Full dihedral (modes included): â‰ˆ 66 distinct "mode families"
  
<span class="dim">But musically distinct scales (by interval content):
  12-TET offers 66 heptachord types
  19-TET: ~280 heptachord types  
  31-TET: ~2,100 heptachord types</span>
  </div>

  <h3>3.2 Chord Graphs and Markov Chains</h3>
  <p>A chord progression is a <em>walk on a graph</em> where nodes are chords and edges represent transitions. Classical theory (functional harmony) weights edges by tension-resolution dynamics. In Roman numeral analysis, progressions follow a directed graph with strong attractors: <strong>IVâ†’Vâ†’I</strong> is the highest-weight path.</p>

  <!-- Interactive chord progression -->
  <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(42,50,64,0.06); border: 1px solid rgba(42,50,64,0.15);">
    <div class="tag-line">Interactive â€” Tonal Function Graph</div>
    <p style="font-size:0.9rem; margin-bottom:1rem;">Click a chord to trace its most probable next moves in functional harmony. Edge thickness = transition probability.</p>
    <div id="chord-buttons">
      <button class="chord-btn active" onclick="selectChord('I')">I (Tonic)</button>
      <button class="chord-btn" onclick="selectChord('ii')">ii (Supertonic)</button>
      <button class="chord-btn" onclick="selectChord('iii')">iii (Mediant)</button>
      <button class="chord-btn" onclick="selectChord('IV')">IV (Subdominant)</button>
      <button class="chord-btn" onclick="selectChord('V')">V (Dominant)</button>
      <button class="chord-btn" onclick="selectChord('vi')">vi (Submediant)</button>
      <button class="chord-btn" onclick="selectChord('viiÂ°')">viiÂ° (Leading)</button>
    </div>
    <canvas id="chord-canvas" width="460" height="300"></canvas>
    <p class="fig-caption" style="text-align:center;">Fig. 3 â€” Functional harmony as a Markov chain. Arrow weight = empirical probability from Bach chorales.</p>
  </div>

  <h3>3.3 Neural Network Models of Harmony</h3>
  <p>The brain learns harmonic expectations through a process analogous to training a recurrent neural network. Studies using LSTMs trained on chorales reproduce human predictions of chord continuations with >85% accuracy. The network's hidden state encodes tonal context â€” a distributed representation of "where we are" in harmonic space.</p>

  <div class="math-block">
<span class="comment">-- LSTM harmony model (Hadjeres & Pachet 2017) --</span>

Input: one-hot chord vector  x_t âˆˆ â„^N  (N = chord vocabulary)

Hidden state update:
  <span class="highlight">h_t</span> = LSTM(x_t, h_{t-1})
  
Output: probability distribution over next chords
  <span class="highlight">P(chord_{t+1} | context)</span> = softmax(W Â· h_t + b)

Training: cross-entropy loss on Bach corpus (371 chorales)

<span class="dim">What h_t encodes (via probing classifiers):
  - Current key (accuracy 94%)
  - Distance from tonic (accuracy 81%)
  - Tension level (correlation r=0.76 with music theory)
  - Expected cadence in n steps (accuracy 72%)</span>

<span class="highlight">The network rediscovers</span>:
  - Ii-V-I motion without being told
  - Tonicization of V before modulation
  - Increased dissonance before cadence
  </div>

  <h3>3.4 Transformer Models and Long-Range Harmonic Structure</h3>
  <p>Transformer attention heads in large music language models (Music Transformer, MusicLM) learn to attend across <em>phrase boundaries</em>, capturing the hierarchical structure of tonality: chord â†’ phrase â†’ section â†’ movement. Each attention head appears to specialize â€” some track the bass line, others the cadential rhythm, others the voice-leading distance.</p>

  <div class="callout" data-label="Emergent Music Theory">
    <p>When GPT-4 class models are trained on symbolic music, they re-derive functional harmony, cadences, phrase symmetry, and even the preference for diatonic over chromatic motion â€” from raw data, with no music-theoretic priors. This suggests these structures are <em>optimal codes</em> for a particular kind of sequence data, not arbitrary cultural conventions.</p>
  </div>

  <h3>3.5 Microtonal Progressions: Expanding the Graph</h3>
  <p>In 31-TET, the chord vocabulary expands dramatically. The dominant seventh chord that resolves to I can be <em>voice-led through different intermediate microtonal chords</em>, creating progressions that are impossible in 12-TET. The 7-limit otonal tetrad (4:5:6:7) resolves even more powerfully than the 12-TET dominant 7th because the 7th partial (7:4) is a just interval â€” its roughness drops to near zero on resolution.</p>

  <div class="math-block">
<span class="comment">-- 31-TET dominant â†’ tonic resolution, extended --</span>

<span class="highlight">7-limit otonal chord</span>  (in 31-TET):
  0 + 10 + 18 + 25  steps  =  0, 387, 697, 968 cents
  Ratio: 4 : 5 : 6 : 7      â† pure harmonic series segment

Resolution to tonic:
  Voice 1: 0Â¢    â†’ 0Â¢     (root  C, stationary)
  Voice 2: 387Â¢  â†’ 386Â¢   (third E, moves âˆ’1Â¢)
  Voice 3: 697Â¢  â†’ 702Â¢   (fifth G, moves +5Â¢)
  Voice 4: 968Â¢  â†’ 1200Â¢  (7th Bâ™­, resolves +232Â¢)

<span class="highlight">Roughness before</span>: ~0.18  (very low â€” near-pure intervals)
<span class="highlight">Roughness after</span>:  ~0.08  (even lower â€” pure consonance)
â†’ Maximum tension-release dynamic

<span class="dim">Compare 12-TET dominant 7th (0, 400, 700, 1000Â¢):
  7th partial is 31Â¢ sharp from pure 7:4 â†’ more beating
  Resolution is less dramatic aurally</span>
  </div>

  <h3>3.6 The Tonnetz as a Neural Architecture</h3>
  <p>There is a striking parallel between the Tonnetz and the structure of grid cells in the hippocampal formation. Grid cells fire in hexagonal lattice patterns to encode spatial position; they may also encode <em>relational</em> position in conceptual spaces. The hypothesis (Bellmund et al., 2018) is that the brain uses grid-like codes for abstract relational reasoning â€” including harmonic relationships. The Tonnetz may be the brain's internal map for navigating harmonic space, not merely a music theorist's diagram.</p>

  <div class="math-block">
<span class="comment">-- Grid cell / Tonnetz homology --</span>

Grid cell field:  hexagonal lattice in â„Â²
  Period vectors: <span class="highlight">aâ‚, aâ‚‚</span>  (â‰ˆ60Â° angle between them)

Tonnetz lattice:  hexagonal tiling of pitch classes
  Generator 1: <span class="highlight">perfect fifth</span>  (3:2, ~702Â¢)
  Generator 2: <span class="highlight">major third</span>   (5:4, ~386Â¢)
  Angle: arccos((702Â²+386Â²-(-816)Â²)/(2Â·702Â·386)) â‰ˆ 60Â°

<span class="highlight">The lattice is hexagonal in both cases.</span>
  If the auditory cortex uses grid-like harmonic codes,
  then musical tension = distance from "home" on the lattice
  and chord progressions = path planning in that space.
  </div>

</section>


<!-- â•â•â•â•â•â•â•â•â•â•â• CHAPTER 4 -->
<section class="chapter">
  <p class="chapter-num">Chapter IV â€” Synthesis</p>
  <h2>A Unified <em>Theory of Tuning</em></h2>

  <h3>4.1 Why Equal Temperament Won (and What It Sacrificed)</h3>
  <p>12-TET is a pragmatic compromise: it closes the circle of fifths, enables free transposition, and approximates 3-limit intervals well. Its 5-limit thirds (400Â¢ vs JI 386Â¢) are 14Â¢ sharp â€” audible on sustained organ chords, tolerable on piano (inharmonicity masks it). It sacrifices the 7-limit entirely. This was not a mathematical inevitability but a historical choice, enabled by keyboard instrument standardization around 1700â€“1800.</p>

  <h3>4.2 Microtonal Systems: Different Trade-offs</h3>
  <p>Each equal temperament is a different projection of the just intonation lattice onto a cyclic group. The quality of approximation can be measured by the <strong>error vector</strong> for each prime limit:</p>

  <div class="math-block">
<span class="comment">-- Tuning system comparison (cents error from JI) --</span>

         12-TET    19-TET    31-TET    53-TET    72-TET
3-limit:
  5th    âˆ’1.96     âˆ’7.22     âˆ’5.18     âˆ’0.07     +1.96  Â¢
  
5-limit:
  3rd   +13.69    âˆ’7.37     +1.08     +1.41     âˆ’2.14  Â¢

7-limit:
  7th   âˆ’31.17    âˆ’21.47    +1.08    +âˆ’4.38     +2.16  Â¢

11-limit:
  11th  âˆ’48.68    +17.10    +0.00    âˆ’19.98     âˆ’0.00  Â¢

<span class="highlight">31-TET</span>: excellent 5-limit AND 7-limit. Used by: Huygens, 
          Fokker, Partch (31-note Adapted Guitar).
<span class="highlight">53-TET</span>: nearly perfect 3- and 5-limit. Ancient Chinese 
          discovery (Ching Fang, 45 BCE).
<span class="highlight">72-TET</span>: standard in Byzantine chant theory. 1/6-tone resolution.
  </div>

  <h3>4.3 The Consonance Landscape as an Optimization Problem</h3>
  <p>We can now state a unified principle: a <strong>tuning scale is an optimal codebook</strong> for a communication channel defined by the harmonic series and the roughness function. The brain is the decoder. A "good" scale packs as many low-roughness intervals as possible into as few notes as possible, enabling rich harmonic expression with limited cognitive load.</p>

  <div class="callout" data-label="Unifying Statement">
    <p><strong>A musical scale is a maximally even discrete approximation to the continuous just-intonation lattice, chosen to minimize average roughness across the most common interval classes, subject to the constraint that the pitch classes form a group under the transposition operator.</strong></p>
    <p style="margin-top:0.8rem; font-size:0.9rem;">This statement unifies Clough & Douthett's combinatorics, Sethares's psychoacoustics, and Tymoczko's geometry into a single optimization criterion.</p>
  </div>

  <h3>4.4 Progressions as Information Flow</h3>
  <p>From a Shannon information-theoretic perspective, a chord progression is a sequence drawn from a Markov chain whose transition probabilities encode <em>stylistic expectations</em>. Tension = surprise = negative log-probability of the chord given context. Resolution = return to the high-probability basin (tonic). A perfect cadence (Vâ†’I) is not just a "formula" â€” it is the path from a high-entropy state (dominant, many possible continuations) to a low-entropy attractor (tonic, stable resting point).</p>

  <div class="math-block">
<span class="comment">-- Tonal tension as information content --</span>

P(chord | key context) â† learned from corpus

<span class="highlight">Tension</span>  T(c) = âˆ’logâ‚‚ P(c | context)   [bits]

Tonic (I):    P â‰ˆ 0.35  â†’  T â‰ˆ 1.5 bits
Dominant (V): P â‰ˆ 0.18  â†’  T â‰ˆ 2.5 bits
Subtonic viiÂ°:P â‰ˆ 0.04  â†’  T â‰ˆ 4.6 bits
Chromatic alt:P â‰ˆ 0.001 â†’  T â‰ˆ 10  bits  (surprise!)

<span class="highlight">Cadence</span> = maximal tension-release:
  V (T=2.5) â†’ I (T=1.5):  Î”T = âˆ’1.0 bits   (regular cadence)
  viiÂ°(T=4.6) â†’ I (T=1.5): Î”T = âˆ’3.1 bits   (leading-tone resolution)

<span class="dim">Jazz: higher-entropy chains (more chromatic harmony)
  â†’ more information per chord change
  â†’ greater perceived sophistication / complexity</span>
  </div>

</section>


<div class="sep">Â· Â· Â·</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• CODA -->
<section>
  <h3 style="font-size:2rem; font-family:'Playfair Display',serif; color:var(--slate); margin-bottom:1.5rem;">Coda: The Score of the Universe</h3>
  <p>Tuning systems are not cultural accidents. They are the outcome of three interacting constraints: the <strong>physics of vibration</strong> (harmonic series, roughness), the <strong>architecture of auditory cognition</strong> (virtual pitch, critical bandwidth, Bayesian expectation), and the <strong>mathematics of discrete approximation</strong> (lattice theory, maximally even sets, group quotients).</p>
  <p>Microtonal music does not break the rules â€” it relaxes the approximation tolerance, allowing access to deeper strata of the just-intonation lattice: 7-limit chords with extraordinary purity, 11-limit intervals with otherworldly color, scales with structural symmetries impossible in 12 notes. The brain, being a biological neural network trained on whatever it hears, can adapt.</p>
  <p>The Tonnetz is simultaneously Euler's 18th-century lattice, Tymoczko's 21st-century orbifold, and potentially the brain's own internal coordinate system for harmonic space â€” grid cells for sound. Music theory, psychoacoustics, and neuroscience are converging on the same geometric object.</p>
  <div class="pullquote">"The musician who composes is doing geometry without knowing it; the mathematician who does geometry is composing without knowing it." â€” paraphrasing Leibniz</div>
  <p>What we call "music theory" is a partially-rediscovered, empirically-validated, neurologically-implemented fragment of algebraic geometry. The rest awaits composers bold enough to explore it.</p>
</section>

</main>

<footer>
  <p>Algebraic Geometry Â· Psychoacoustics Â· Neural Networks Â· Combinatorics</p>
  <p style="margin-top:0.5rem; opacity:0.5;">Tonnetz Â· Orbifolds Â· Roughness Â· Markov Chains Â· JI Lattices Â· Equal Temperament</p>
</footer>


<script>
// â”€â”€â”€ READ PROGRESS â”€â”€â”€
window.addEventListener('scroll', () => {
  const h = document.documentElement;
  const pct = h.scrollTop / (h.scrollHeight - h.clientHeight) * 100;
  document.getElementById('rp').style.width = pct + '%';
});

// â”€â”€â”€ TONNETZ â”€â”€â”€
(function() {
  const svg = document.getElementById('tonnetz');
  const W = 480, H = 320;
  const notes = ['C','G','D','A','E','B','Fâ™¯','Câ™¯','Gâ™¯','Eâ™­','Bâ™­','F'];
  // 5th = +7 steps in chromatic, third = +4 steps
  // Tonnetz: cols = fifths, rows = major thirds
  const cols = 9, rows = 5;
  const dx = 52, dy = 55;
  const ox = 30, oy = 30;

  // Color: hue based on pitch class
  function pcColor(pc) {
    const hues = [0,210,30,180,60,150,90,270,120,240,300,330];
    const h = hues[pc % 12];
    return `hsl(${h}, 55%, 72%)`;
  }

  function pitchAt(col, row) {
    // col = fifths (+7 semitones), row = thirds (+4 semitones)
    return ((col * 7 + row * 4) % 12 + 12) % 12;
  }

  let svgContent = '';

  // Draw triangles first
  for (let r = 0; r < rows - 1; r++) {
    for (let c = 0; c < cols - 1; c++) {
      const x = ox + c * dx + r * (dx/2);
      const y = oy + r * dy;
      // Upper triangle (major): (c,r), (c+1,r), (c,r+1) + half offset
      const x1 = x, y1 = y;
      const x2 = x + dx, y2 = y;
      const x3 = ox + (c) * dx + (r+1) * (dx/2), y3 = oy + (r+1) * dy;
      const x4 = ox + (c+1) * dx + (r+1) * (dx/2);
      // major triad triangle
      svgContent += `<polygon points="${x1},${y1} ${x2},${y2} ${x3},${y3}" fill="rgba(184,134,11,0.12)" stroke="#b8860b" stroke-width="0.8"/>`;
      // minor triad triangle
      svgContent += `<polygon points="${x2},${y2} ${x3},${y3} ${x4},${y3}" fill="rgba(139,37,0,0.08)" stroke="#8b2500" stroke-width="0.8"/>`;
    }
  }

  // Draw nodes
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const pc = pitchAt(c, r);
      const x = ox + c * dx + r * (dx/2);
      const y = oy + r * dy;
      const col = pcColor(pc);
      svgContent += `<circle cx="${x}" cy="${y}" r="16" fill="${col}" stroke="#2a3240" stroke-width="1.5"/>`;
      svgContent += `<text x="${x}" y="${y+5}" text-anchor="middle" fill="#0e0e10" font-size="11" font-weight="500">${notes[pc]}</text>`;
    }
  }

  // Legend
  svgContent += `<rect x="10" y="${H-30}" width="14" height="14" fill="rgba(184,134,11,0.2)" stroke="#b8860b" stroke-width="0.8"/>`;
  svgContent += `<text x="28" y="${H-19}" fill="#f5f0e8" font-size="10">Major triad</text>`;
  svgContent += `<rect x="110" y="${H-30}" width="14" height="14" fill="rgba(139,37,0,0.15)" stroke="#8b2500" stroke-width="0.8"/>`;
  svgContent += `<text x="128" y="${H-19}" fill="#f5f0e8" font-size="10">Minor triad</text>`;

  svg.innerHTML = svgContent;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
})();

// â”€â”€â”€ HARMONIC SERIES â”€â”€â”€
(function() {
  const canvas = document.getElementById('harmonic');
  if (!canvas) return;
  canvas.width = 800; canvas.height = 140;
  const ctx = canvas.getContext('2d');
  const f0 = 220, f5 = 330; // A3 and E4

  ctx.fillStyle = '#2a3240';
  ctx.fillRect(0, 0, 800, 140);

  const maxF = 2000;
  const W = 800, H = 120, pad = 20;

  function xPos(f) { return pad + (f / maxF) * (W - 2*pad); }

  // Grid
  ctx.strokeStyle = 'rgba(245,240,232,0.08)';
  ctx.lineWidth = 1;
  for (let f = 200; f <= maxF; f += 200) {
    const x = xPos(f);
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }

  // Harmonics of f0 (220 Hz) â€” steel blue
  for (let k = 1; k * f0 <= maxF; k++) {
    const f = k * f0;
    const x = xPos(f);
    const amp = 1/k;
    const barH = amp * 80;
    const isShared = (f % f5 < 1 || f5 % (f - Math.floor(f/f5)*f5) < 1) && f % f5 === 0;
    ctx.fillStyle = isShared ? '#e8c860' : '#6ab0d8';
    ctx.fillRect(x - 3, H - barH, 6, barH);
    if (k <= 8) {
      ctx.fillStyle = 'rgba(245,240,232,0.5)';
      ctx.font = '9px DM Mono, monospace';
      ctx.fillText(k, x - 3, H - barH - 4);
    }
  }

  // Harmonics of f5 (330 Hz) â€” rust
  for (let k = 1; k * f5 <= maxF; k++) {
    const f = k * f5;
    const x = xPos(f);
    const amp = 1/k;
    const barH = amp * 60;
    const shared = Number.isInteger(f / f0) && f % f0 === 0;
    if (!shared) {
      ctx.fillStyle = 'rgba(139,37,0,0.8)';
      ctx.fillRect(x - 2, H - barH, 4, barH);
    }
  }

  // Dashed markers for shared harmonics
  ctx.setLineDash([3,3]);
  ctx.strokeStyle = '#e8c860';
  ctx.lineWidth = 1;
  [660, 1320, 1980].forEach(f => {
    if (f <= maxF) {
      const x = xPos(f);
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
  });
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#6ab0d8';
  ctx.font = '10px DM Mono, monospace';
  ctx.fillText('A3 (220 Hz) harmonics', 10, 12);
  ctx.fillStyle = 'rgba(139,37,0,0.9)';
  ctx.fillText('E4 (330 Hz) harmonics', 10, 26);
  ctx.fillStyle = '#e8c860';
  ctx.fillText('shared', 10, 40);

  // Hz labels
  ctx.fillStyle = 'rgba(245,240,232,0.3)';
  ctx.font = '9px DM Mono, monospace';
  [500, 1000, 1500, 2000].forEach(f => {
    ctx.fillText(f+'Hz', xPos(f) - 15, H + 15);
  });
})();

// â”€â”€â”€ CHORD GRAPH â”€â”€â”€
const chordData = {
  'I':    { label:'I',   x:230, y:150, color:'#1a4a6b' },
  'ii':   { label:'ii',  x:320, y:80,  color:'#2a3240' },
  'iii':  { label:'iii', x:390, y:150, color:'#2a3240' },
  'IV':   { label:'IV',  x:320, y:220, color:'#2a3240' },
  'V':    { label:'V',   x:390, y:80,  color:'#8b2500' },
  'vi':   { label:'vi',  x:150, y:80,  color:'#2a3240' },
  'viiÂ°': { label:'viiÂ°',x:390, y:220, color:'#5a3a00' },
};

const edges = {
  'I':    [['V',0.35],['IV',0.25],['vi',0.20],['ii',0.10],['iii',0.05],['viiÂ°',0.05]],
  'ii':   [['V',0.55],['IV',0.20],['viiÂ°',0.15],['I',0.10]],
  'iii':  [['vi',0.40],['IV',0.25],['I',0.20],['ii',0.10],['V',0.05]],
  'IV':   [['V',0.45],['I',0.25],['ii',0.15],['viiÂ°',0.10],['vi',0.05]],
  'V':    [['I',0.70],['vi',0.18],['IV',0.07],['ii',0.05]],
  'vi':   [['ii',0.35],['IV',0.30],['V',0.20],['I',0.10],['iii',0.05]],
  'viiÂ°': [['I',0.70],['V',0.20],['vi',0.10]],
};

let selectedChord = 'I';

function selectChord(c) {
  selectedChord = c;
  document.querySelectorAll('.chord-btn').forEach(b => {
    b.classList.toggle('active', b.textContent.startsWith(c.replace('Â°','Â°')));
  });
  drawChordGraph();
}

function drawChordGraph() {
  const canvas = document.getElementById('chord-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#2a3240';
  ctx.fillRect(0, 0, W, H);

  const from = chordData[selectedChord];
  const trans = edges[selectedChord] || [];

  // Draw edges
  trans.forEach(([to, prob]) => {
    const t = chordData[to];
    if (!t) return;
    const lw = prob * 12;

    // Arrow
    const dx = t.x - from.x, dy = t.y - from.y;
    const len = Math.sqrt(dx*dx + dy*dy);
    const ux = dx/len, uy = dy/len;
    const startX = from.x + ux*26, startY = from.y + uy*26;
    const endX = t.x - ux*26, endY = t.y - uy*26;

    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(endX, endY);
    ctx.strokeStyle = `rgba(232,200,96,${0.4 + prob * 0.6})`;
    ctx.lineWidth = lw;
    ctx.stroke();

    // Arrowhead
    const angle = Math.atan2(endY - startY, endX - startX);
    ctx.save();
    ctx.translate(endX, endY);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(-10, -5);
    ctx.lineTo(-10, 5);
    ctx.closePath();
    ctx.fillStyle = `rgba(232,200,96,${0.5 + prob*0.5})`;
    ctx.fill();
    ctx.restore();

    // Probability label
    const mx = (startX + endX)/2, my = (startY + endY)/2;
    ctx.fillStyle = '#e8c860';
    ctx.font = '10px DM Mono, monospace';
    ctx.fillText(Math.round(prob*100)+'%', mx+4, my-4);
  });

  // Draw nodes
  Object.entries(chordData).forEach(([key, node]) => {
    const isFrom = key === selectedChord;
    const isDest = trans.find(([to]) => to === key);

    ctx.beginPath();
    ctx.arc(node.x, node.y, 22, 0, Math.PI*2);
    ctx.fillStyle = isFrom ? '#b8860b' : (isDest ? '#1a4a6b' : 'rgba(42,50,64,0.8)');
    ctx.fill();
    ctx.strokeStyle = isFrom ? '#e8c860' : 'rgba(245,240,232,0.2)';
    ctx.lineWidth = isFrom ? 2.5 : 1;
    ctx.stroke();

    ctx.fillStyle = '#f5f0e8';
    ctx.font = `${key.length > 2 ? '10' : '13'}px DM Mono, monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(key, node.x, node.y);
  });

  ctx.textAlign = 'left';
  ctx.textBaseline = 'alphabetic';
}

// Initial draw
drawChordGraph();

// Make canvas properly sized
const cc = document.getElementById('chord-canvas');
if (cc) { cc.width = 460; cc.height = 300; drawChordGraph(); }

</script>
</body>
</html>
